{% extends 'base.html' %}

{% block title %}{{ tournament.name }} - Tournament Details{% endblock %}

{% block content %}
<div class="container mt-5 pt-4">
    <div class="row">
        <div class="col-12">
            <!-- Tournament Header -->
            <div class="card mb-4">
                {% if tournament.banner %}
                    <img src="{{ tournament.banner.url }}" class="card-img-top" alt="{{ tournament.name }}"
                         style="height: 300px; object-fit: cover;">
                {% endif %}
                <div class="card-header text-center py-4">
                    <h1 class="mb-3 text-light">
                        <i class="bi bi-trophy-fill text-warning me-2"></i>{{ tournament.name }}
                        <span class="badge bg-danger ms-2">ADMIN MODE</span>
                    </h1>
                    <div class="row justify-content-center">
                        <div class="col-auto">
                            {% if tournament.status == 'upcoming' %}
                                <span class="badge bg-warning text-dark fs-6">Upcoming</span>
                            {% elif tournament.status == 'ongoing' %}
                                <span class="badge bg-success fs-6">Ongoing</span>
                            {% elif tournament.status == 'completed' %}
                                <span class="badge bg-secondary fs-6">Completed</span>
                            {% else %}
                                <span class="badge bg-danger fs-6">Cancelled</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="text-light">About Tournament</h5>
                            <p class="text-light">{{ tournament.description|default:"No description available." }}</p>

                            <div class="row g-3 mt-3">
                                <div class="col-sm-6">
                                    <div class="card bg-transparent border-primary">
                                        <div class="card-body text-center">
                                            <i class="bi bi-cash-stack display-6 text-warning"></i>
                                            <h5 class="text-light">Prize Pool</h5>
                                            <h4 class="text-warning">${{ tournament.prize_pool|floatformat:0 }}</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="card bg-transparent border-success">
                                        <div class="card-body text-center">
                                            <i class="bi bi-people-fill display-6 text-success"></i>
                                            <h5 class="text-light">Teams</h5>
                                            <h4 class="text-success">{{ participants.count }}/{{ tournament.max_teams }}</h4>
                                            {% if spots_left > 0 %}
                                                <small class="text-light">{{ spots_left }} spots left</small>
                                            {% else %}
                                                <small class="text-warning">Tournament Full</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-transparent">
                                <div class="card-body">
                                    <h6 class="text-light"><i class="bi bi-calendar3 text-primary"></i> Schedule</h6>
                                    <p class="mb-2 text-light">
                                        <strong>Start:</strong><br>
                                        {{ tournament.start_date|date:"F d, Y \a\t H:i" }}
                                    </p>
                                    <p class="mb-2 text-light">
                                        <strong>End:</strong><br>
                                        {{ tournament.end_date|date:"F d, Y \a\t H:i" }}
                                    </p>
                                    <p class="mb-3 text-light">
                                        <strong>Registration Deadline:</strong><br>
                                        {{ tournament.registration_deadline|date:"F d, Y \a\t H:i" }}
                                    </p>

                                    <h6 class="text-light"><i class="bi bi-person-badge text-success"></i> Organizer</h6>
                                    <p class="mb-0 text-light">{{ tournament.organizer.username }}</p>
                                    {% if tournament.organizer.rank %}
                                        <span class="rank-badge">{{ tournament.organizer.get_rank_display }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 🔥 TOURNAMENT ADMIN PANEL - ALWAYS VISIBLE FOR TESTING -->
            <div class="card mb-4 border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-gear-fill me-2"></i>Tournament Admin Panel
                        <span class="badge bg-dark ms-2">TESTING MODE</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Add Teams Section -->
                        <div class="col-md-6">
                            <h6 class="text-danger mb-3">
                                <i class="bi bi-plus-circle me-2"></i>Add Team to Tournament
                            </h6>

                            {% if available_teams_for_admin %}
                            <form method="post" action="{% url 'admin_add_team' tournament.pk %}">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-light">Select Team:</label>
                                    <select name="team_id" class="form-control" required id="teamSelector">
                                        <option value="">-- Choose Team to Add --</option>

                                        {% if professional_teams %}
                                        <optgroup label="🏆 Professional Teams">
                                            {% for team in professional_teams %}
                                            <option value="{{ team.id }}" data-type="pro">
                                                {% if team.get_country_flag %}{{ team.get_country_flag }}{% endif %}
                                                [{{ team.tag }}] {{ team.name }}
                                                {% if team.world_ranking %}(#{{ team.world_ranking }}){% endif %}
                                            </option>
                                            {% endfor %}
                                        </optgroup>
                                        {% endif %}

                                        {% if community_teams %}
                                        <optgroup label="🎮 Community Teams">
                                            {% for team in community_teams %}
                                            <option value="{{ team.id }}" data-type="community">
                                                {% if team.get_country_flag %}{{ team.get_country_flag }}{% endif %}
                                                [{{ team.tag }}] {{ team.name }}
                                            </option>
                                            {% endfor %}
                                        </optgroup>
                                        {% endif %}
                                    </select>
                                </div>

                                <div class="d-grid">
                                    <button type="submit" class="btn btn-success"
                                            {% if spots_left <= 0 %}disabled{% endif %}>
                                        <i class="bi bi-plus-circle me-2"></i>Add Selected Team
                                        {% if spots_left <= 0 %}(Tournament Full){% endif %}
                                    </button>
                                </div>
                            </form>
                            {% else %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                All available teams are already registered!
                            </div>
                            {% endif %}
                        </div>

                        <!-- Quick Stats -->
                        <div class="col-md-6">
                            <h6 class="text-info mb-3">
                                <i class="bi bi-bar-chart me-2"></i>Tournament Stats
                            </h6>

                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="card bg-success text-white">
                                        <div class="card-body text-center py-2">
                                            <h5 class="mb-0">{{ participants|length }}</h5>
                                            <small>Registered</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card bg-warning text-dark">
                                        <div class="card-body text-center py-2">
                                            <h5 class="mb-0">{{ spots_left }}</h5>
                                            <small>Spots Left</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card bg-primary text-white">
                                        <div class="card-body text-center py-2">
                                            <h5 class="mb-0">{{ professional_teams|length|default:0 }}</h5>
                                            <small>Pro Available</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card bg-info text-white">
                                        <div class="card-body text-center py-2">
                                            <h5 class="mb-0">{{ community_teams|length|default:0 }}</h5>
                                            <small>Community Available</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Participants Section -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="text-light"><i class="bi bi-list-ul me-2"></i>Participating Teams ({{ participants.count }})</h5>
                    <small class="text-light">Click X to remove teams</small>
                </div>
                <div class="card-body">
                    {% if participants %}
                        <div class="row g-3">
                            {% for participation in participants %}
                            <div class="col-md-6 col-lg-4">
                                <div class="card bg-transparent border-primary team-card
                                            {% if participation.team.is_professional %}border-warning pro-team{% endif %} admin-team-card">
                                    <div class="card-body text-center position-relative">

                                        <!-- Remove Button -->
                                        <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-2"
                                                onclick="showRemoveModal('{{ participation.team.id }}', '{{ participation.team.name }}', '{{ participation.team.tag }}')"
                                                title="Remove Team">
                                            <i class="bi bi-x-lg"></i>
                                        </button>

                                        <!-- Team Logo -->
                                        {% if participation.team.logo %}
                                            <img src="{{ participation.team.logo.url }}" alt="{{ participation.team.name }}"
                                                 class="rounded mb-2" style="width: 60px; height: 60px; object-fit: cover;">
                                        {% else %}
                                            <i class="bi bi-shield-fill display-5 text-primary mb-2"></i>
                                        {% endif %}

                                        <!-- Team Info -->
                                        <h6 class="team-name text-light">
                                            {% if participation.team.get_country_flag %}
                                                {{ participation.team.get_country_flag }}
                                            {% endif %}
                                            [{{ participation.team.tag }}] {{ participation.team.name }}
                                        </h6>

                                        <!-- Team Type Badge -->
                                        {% if participation.team.is_professional %}
                                            <span class="badge bg-warning text-dark mb-2">PRO TEAM</span>
                                            {% if participation.team.world_ranking %}
                                                <span class="badge bg-info mb-2">#{{ participation.team.world_ranking }}</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-primary mb-2">COMMUNITY</span>
                                        {% endif %}

                                        <!-- Registration Date -->
                                        <p class="text-light small mt-2">
                                            Registered: {{ participation.registration_date|date:"M d" }}
                                        </p>

                                        <!-- View Team Button -->
                                        <a href="{% url 'team_detail' participation.team.pk %}"
                                           class="btn btn-outline-light btn-sm">
                                            View Team
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-people display-4 text-muted"></i>
                            <h5 class="text-muted mt-2">No teams registered yet</h5>
                            <p class="text-muted">Use the admin panel above to add teams!</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Back Button + Delete Tournament -->
            <div class="text-center mt-4">
                <a href="{% url 'tournament_list' %}" class="btn btn-outline-light">
                    <i class="bi bi-arrow-left"></i> Back to Tournaments
                </a>
                <button class="btn btn-outline-danger ms-2" onclick="showDeleteConfirm({{ tournament.id }})">
                    <i class="bi bi-trash3"></i> Delete Tournament
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Custom Delete Confirmation Modal -->
<div id="deleteTournamentModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #dc3545;">
            <div class="modal-header border-0 text-center">
                <h4 class="modal-title w-100 text-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Delete Tournament?
                </h4>
            </div>
            <div class="modal-body text-center">
                <p class="text-white mb-3">Are you sure you want to delete this tournament?</p>
                <p class="text-warning small">All participants will be removed!</p>
                <p class="text-danger small">This action cannot be undone!</p>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmTournamentDelete()">
                    <i class="bi bi-trash3-fill me-2"></i>Delete Tournament
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 🎮 GAMING MODAL FOR TEAM REMOVAL - FIXED STYLING -->
<div class="modal fade" id="removeTeamModal" tabindex="-1" aria-labelledby="removeTeamModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #dc3545;">
            <div class="modal-header border-0 text-center">
                <div class="w-100">
                    <div class="warning-icon mb-3">
                        <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 3rem;"></i>
                    </div>
                    <h4 class="modal-title text-danger fw-bold" id="removeTeamModalLabel">
                        <i class="bi bi-shield-x me-2"></i>REMOVE TEAM WARNING
                    </h4>
                </div>
            </div>
            <div class="modal-body text-center py-4">
                <div class="team-info-preview mb-4">
                    <div class="team-avatar mb-3">
                        <i class="bi bi-shield-fill text-primary" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="team-name-display text-warning fw-bold mb-3"></h5>
                    <p class="text-danger mb-3 fw-bold">
                        <i class="bi bi-exclamation-circle me-2"></i>
                        This action cannot be undone!
                    </p>
                </div>

                <div class="alert alert-danger border border-warning" style="background: rgba(220, 53, 69, 0.2);">
                    <i class="bi bi-info-circle text-warning me-2"></i>
                    <span class="text-white">The team will be permanently removed from this tournament.</span>
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <form id="removeTeamForm" method="post" action="{% url 'admin_remove_team' tournament.pk %}">
                    {% csrf_token %}
                    <input type="hidden" name="team_id" id="removeTeamId">
                    <div class="d-flex gap-3">
                        <button type="button" class="btn btn-outline-light px-4" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-2"></i>Cancel
                        </button>
                        <button type="submit" class="btn btn-danger px-4">
                            <i class="bi bi-trash me-2"></i>Remove Team
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* Admin Panel Styling */
.admin-team-card {
    transition: all 0.3s ease;
    cursor: pointer;
}

.admin-team-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(255, 0, 0, 0.2);
}

.pro-team {
    background: linear-gradient(145deg, rgba(255, 215, 0, 0.1), rgba(255, 140, 0, 0.05));
    border-color: #ffd700 !important;
}

.team-card {
    transition: all 0.3s ease;
}

.team-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 212, 255, 0.2);
}

.team-name {
    margin-top: 0.5rem;
    font-weight: 600;
}

/* Team Selector Styling */
#teamSelector {
    background: var(--secondary-bg);
    border: 2px solid var(--border-color);
    color: var(--text-primary);
    font-size: 1rem;
    padding: 0.75rem;
    border-radius: 8px;
    transition: all 0.3s ease;
}

#teamSelector:focus {
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 0.2rem var(--glow-blue);
    background: var(--accent-bg);
}

#teamSelector option {
    background: var(--secondary-bg);
    color: var(--text-primary);
    padding: 0.5rem;
}

#teamSelector optgroup {
    background: var(--primary-bg);
    color: var(--warning-yellow);
    font-weight: 700;
}

/* Badge styling improvements */
.badge {
    font-size: 0.75rem;
    font-weight: 600;
}

.badge.bg-warning {
    color: var(--primary-bg) !important;
}
</style>

<script>
let tournamentToDelete = null;

function showDeleteConfirm(tournamentId) {
    tournamentToDelete = tournamentId;
    const modal = new bootstrap.Modal(document.getElementById('deleteTournamentModal'));
    modal.show();
}

function confirmTournamentDelete() {
    if (tournamentToDelete) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteTournamentModal'));
        modal.hide();

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/tournaments/${tournamentToDelete}/delete/`;

        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;

        form.appendChild(csrfInput);
        document.body.appendChild(form);
        form.submit();
    }
}

function showRemoveModal(teamId, teamName, teamTag) {
    document.getElementById('removeTeamId').value = teamId;
    document.querySelector('.team-name-display').textContent = `[${teamTag}] ${teamName}`;

    const modal = new bootstrap.Modal(document.getElementById('removeTeamModal'));
    modal.show();
}

// Enhanced team selector
document.addEventListener('DOMContentLoaded', function() {
    const teamSelector = document.getElementById('teamSelector');

    if (teamSelector) {
        teamSelector.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption && selectedOption.value) {
                const teamType = selectedOption.getAttribute('data-type');

                if (teamType === 'pro') {
                    this.style.borderColor = '#ffd700';
                    this.style.boxShadow = '0 0 0 0.2rem rgba(255, 215, 0, 0.3)';
                } else {
                    this.style.borderColor = '#007bff';
                    this.style.boxShadow = '0 0 0 0.2rem rgba(0, 123, 255, 0.3)';
                }
            } else {
                this.style.borderColor = '';
                this.style.boxShadow = '';
            }
        });
    }

    // Form submission with loading state
    const removeForm = document.getElementById('removeTeamForm');
    if (removeForm) {
        removeForm.addEventListener('submit', function() {
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Removing...';
            submitBtn.disabled = true;
        });
    }
});
</script>
{% endblock %}