{% extends 'base.html' %}

{% block title %}{{ match.team1.name }} vs {{ match.team2.name }} - Match Details{% endblock %}

{% block content %}
<div class="container mt-5 pt-4">
    <div class="row">
        <div class="col-12">
            <!-- Match Header -->
            <div class="card mb-4">
                <div class="card-header text-center py-4">
                    <h2 class="mb-3">
                        <span class="text-primary">{{ match.team1.name }}</span>
                        <span class="mx-3">vs</span>
                        <span class="text-success">{{ match.team2.name }}</span>
                    </h2>
                    <div class="row justify-content-center">
                        <div class="col-auto">
                            <span class="badge bg-primary fs-6 me-2">{{ match.get_map_name_display }}</span>
                            <span class="badge bg-secondary fs-6 me-2">{{ match.get_match_type_display }}</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-5">
                            <h3 class="text-primary">[{{ match.team1.tag }}] {{ match.team1.name }}</h3>
                            {% if match.team1.logo %}
                                <img src="{{ match.team1.logo.url }}" alt="{{ match.team1.name }}"
                                     class="img-fluid rounded" style="max-height: 80px;">
                            {% endif %}
                        </div>
                        <div class="col-md-2 d-flex align-items-center justify-content-center">
                            <h1 class="display-3 fw-bold"></h1>
                        </div>
                        <div class="col-md-5">
                            <h3 class="text-success">[{{ match.team2.tag }}] {{ match.team2.name }}</h3>
                            {% if match.team2.logo %}
                                <img src="{{ match.team2.logo.url }}" alt="{{ match.team2.name }}"
                                     class="img-fluid rounded" style="max-height: 80px;">
                            {% endif %}
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <p class="text-muted mb-2">
                            <i class="bi bi-calendar3"></i> {{ match.match_date|date:"F d, Y \a\t H:i" }}
                        </p>
                        {% if match.duration_minutes %}
                            <p class="text-muted">
                                <i class="bi bi-clock"></i> Duration: {{ match.duration_minutes }} minutes
                            </p>
                        {% endif %}
                        {% if match.winner %}
                            <div class="alert alert-success d-inline-block">
                                <i class="bi bi-trophy-fill"></i> Winner: <strong>{{ match.winner.name }}</strong>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Match Actions -->
            {% if user.is_authenticated and not match.is_finished %}
                {% if user in match.team1.memberships.all.player or user in match.team2.memberships.all.player %}
                <div class="text-center mb-4">
                    <a href="{% url 'match_result' match.pk %}" class="btn btn-primary">
                        <i class="bi bi-clipboard-check"></i> Submit Result
                    </a>
                </div>
                {% endif %}
            {% endif %}

            <!-- Player Statistics -->
            {% if player_stats %}
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-people-fill text-primary"></i> {{ match.team1.name }} Stats</h5>
                        </div>
                        <div class="card-body">
                            {% for stat in team1_stats %}
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded"
                                 style="background: rgba(0, 212, 255, 0.1);">
                                <div>
                                    <strong>{{ stat.player.username }}</strong>
                                    {% if stat.player.rank %}
                                        <span class="rank-badge ms-1">{{ stat.player.get_rank_display }}</span>
                                    {% endif %}
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success">{{ stat.kills }}K</span>
                                    <span class="badge bg-danger">{{ stat.deaths }}D</span>
                                    <span class="badge bg-info">{{ stat.assists }}A</span>
                                    <small class="text-muted ms-2">K/D: {{ stat.kd_ratio }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-people-fill text-success"></i> {{ match.team2.name }} Stats</h5>
                        </div>
                        <div class="card-body">
                            {% for stat in team2_stats %}
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded"
                                 style="background: rgba(0, 255, 136, 0.1);">
                                <div>
                                    <strong>{{ stat.player.username }}</strong>
                                    {% if stat.player.rank %}
                                        <span class="rank-badge ms-1">{{ stat.player.get_rank_display }}</span>
                                    {% endif %}
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success">{{ stat.kills }}K</span>
                                    <span class="badge bg-danger">{{ stat.deaths }}D</span>
                                    <span class="badge bg-info">{{ stat.assists }}A</span>
                                    <small class="text-muted ms-2">K/D: {{ stat.kd_ratio }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- AI PREDICTION SECTION -->
            {% if prediction %}
            <div class="card mb-4" style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(255, 107, 53, 0.1)); border: 2px solid #00d4ff;">
                <div class="card-header text-center py-3" style="background: rgba(0, 212, 255, 0.2);">
                    <h4 class="mb-0">
                        <i class="bi bi-robot text-warning me-2" style="font-size: 1.5rem;"></i>
                        <span class="text-gradient">AI Match Prediction</span>
                        <i class="bi bi-cpu text-info ms-2" style="font-size: 1.5rem;"></i>
                    </h4>
                    <small class="text-muted">Advanced machine learning analysis</small>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <!-- Team 1 Prediction -->
                        <div class="col-md-5">
                            <div class="prediction-team p-3 rounded" style="background: rgba(0, 212, 255, 0.15);">
                                <h5 class="text-primary mb-2">[{{ match.team1.tag }}] {{ match.team1.name }}</h5>
                                <div class="prediction-percentage mb-3">
                                    <span class="display-4 fw-bold text-primary">{{ prediction.team1_win_probability }}%</span>
                                    <br><small class="text-muted">Win Probability</small>
                                </div>
                                <div class="betting-odds">
                                    <span class="badge bg-primary fs-6">Odds: {{ prediction.team1_odds }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- VS Section -->
                        <div class="col-md-2 d-flex align-items-center justify-content-center">
                            <div class="text-center">
                                <div style="writing-mode: vertical-lr; text-orientation: mixed;">
                                    <span class="text-warning fw-bold fs-4">VS</span>
                                </div>
                                <div class="mt-2">
                                    <i class="bi bi-lightning-charge text-warning" style="font-size: 2rem;"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Team 2 Prediction -->
                        <div class="col-md-5">
                            <div class="prediction-team p-3 rounded" style="background: rgba(0, 255, 136, 0.15);">
                                <h5 class="text-success mb-2">[{{ match.team2.tag }}] {{ match.team2.name }}</h5>
                                <div class="prediction-percentage mb-3">
                                    <span class="display-4 fw-bold text-success">{{ prediction.team2_win_probability }}%</span>
                                    <br><small class="text-muted">Win Probability</small>
                                </div>
                                <div class="betting-odds">
                                    <span class="badge bg-success fs-6">Odds: {{ prediction.team2_odds }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Prediction Details -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="prediction-factors p-3 rounded" style="background: rgba(255, 255, 255, 0.05);">
                                <h6 class="text-center mb-3 text-light">
                                    <i class="bi bi-graph-up text-info me-2"></i>Analysis Factors
                                </h6>
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <small class="text-muted">Map Performance</small>
                                        <br><span class="text-warning" id="mapFactor">Loading...</span>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Recent Form</small>
                                        <br><span class="text-info" id="formFactor">Loading...</span>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Head-to-Head</small>
                                        <br><span class="text-success" id="h2hFactor">Loading...</span>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Player Rating</small>
                                        <br><span class="text-danger" id="ratingFactor">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Confidence -->
                    <div class="text-center mt-3">
                        <span class="badge bg-warning text-dark fs-6">
                            <i class="bi bi-shield-check me-1"></i>
                            AI Confidence: {{ prediction.confidence }}%
                        </span>
                        {% if prediction.recommended_bet %}
                        <span class="badge bg-info fs-6 ms-2">
                            <i class="bi bi-star-fill me-1"></i>
                            Recommended: {{ prediction.recommended_bet }}
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- RESULTS BUTTON -->
            <div class="text-center mb-4">
                <button class="btn btn-success btn-lg" onclick="showMatchResults()" style="box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);">
                    <i class="bi bi-trophy-fill me-2"></i>🏆 See Match Results
                </button>
            </div>

            <!-- Hidden Results Section (will be shown with JavaScript) -->
            <div id="matchResults" class="card mb-4" style="display: none;">
                <div class="card-header text-center">
                    <h4><i class="bi bi-trophy-fill text-warning me-2"></i>Match Results Breakdown</h4>
                </div>
                <div class="card-body" id="resultsContent">
                    <!-- Results will be loaded here via JavaScript -->
                </div>
            </div>

<!-- Back Button -->
<div class="text-center mt-4">
    <a href="{% url 'match_list' %}" class="btn btn-outline-light">
        <i class="bi bi-arrow-left"></i> Back to Matches
    </a>
    <button class="btn btn-outline-danger ms-2" onclick="showDeleteConfirm({{ match.pk }})">
        <i class="bi bi-trash3"></i> Delete Match
    </button>
</div>

<!-- Custom Delete Confirmation Modal -->
<div id="deleteModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #dc3545;">
            <div class="modal-header border-0 text-center">
                <h4 class="modal-title w-100 text-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Delete Match?
                </h4>
            </div>
            <div class="modal-body text-center">
                <p class="text-white mb-3">Are you sure you want to delete this match?</p>
                <p class="text-muted small">This action cannot be undone!</p>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <i class="bi bi-trash3-fill me-2"></i>Delete Match
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let matchToDelete = null;

function showDeleteConfirm(matchId) {
    matchToDelete = matchId;
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

function confirmDelete() {
    if (matchToDelete) {
        // Hide modal first
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
        modal.hide();

        // Delete match via form submission
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/matches/${matchToDelete}/delete/`;

        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;

        form.appendChild(csrfInput);
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
        </div>
    </div>
</div>

<!-- JavaScript for Results and Actions -->
<script>
// Generate realistic analysis factors when page loads
document.addEventListener('DOMContentLoaded', function() {
    generateAnalysisFactors();
});

function generateAnalysisFactors() {
    // Generate consistent factors based on match ID
    const matchId = {{ match.id }};
    const team1Id = {{ match.team1.id }};
    const team2Id = {{ match.team2.id }};

    // Create seed from match IDs for consistent results
    const seed = (matchId * 13 + team1Id * 7 + team2Id * 3) % 100;

    // Generate realistic percentages using seeded randomness
    const mapFactor = 65 + (seed % 25);        // 65-89%
    const formFactor = 55 + ((seed * 2) % 35); // 55-89%
    const h2hFactor = 45 + ((seed * 3) % 40);  // 45-84%
    const ratingFactor = 60 + ((seed * 5) % 30); // 60-89%

    // Update the display
    document.getElementById('mapFactor').textContent = mapFactor + '%';
    document.getElementById('formFactor').textContent = formFactor + '%';
    document.getElementById('h2hFactor').textContent = h2hFactor + '%';
    document.getElementById('ratingFactor').textContent = ratingFactor + '%';
}

function showMatchResults() {
    const resultsDiv = document.getElementById('matchResults');
    const resultsContent = document.getElementById('resultsContent');

    // Show the results section
    resultsDiv.style.display = 'block';

    // Generate random match breakdown
    const maps = ['Dust2', 'Mirage', 'Inferno', 'Cache', 'Overpass', 'Train', 'Cobblestone'];
    const team1Name = '{{ match.team1.name|escapejs }}';
    const team2Name = '{{ match.team2.name|escapejs }}';
    const team1Tag = '{{ match.team1.tag|escapejs }}';
    const team2Tag = '{{ match.team2.tag|escapejs }}';

    // 🔥 NEW LOGIC - Generate REALISTIC match scores (BO3 format: 2-0, 2-1, 1-2, 0-2)
    const possibleScores = [
        [2, 0], [2, 1], [1, 2], [0, 2]
    ];
    const matchId = {{ match.id }};
    const scoreIndex = matchId % possibleScores.length;
    const [team1Score, team2Score] = possibleScores[scoreIndex];

    const totalMaps = team1Score + team2Score;
    const winner = team1Score > team2Score ? team1Name : team2Name;
    const winnerTag = team1Score > team2Score ? team1Tag : team2Tag;

    let resultsHTML = `
        <div class="text-center mb-4">
            <h2 class="text-warning mb-3">🏆 MATCH RESULTS 🏆</h2>
            <div class="winner-announcement p-4 rounded" style="background: linear-gradient(45deg, rgba(255, 215, 0, 0.2), rgba(255, 107, 53, 0.2)); border: 2px solid gold;">
                <h3 class="text-gold mb-2">WINNER: [${winnerTag}] ${winner}</h3>
                <h2 class="mb-3">
                    <span class="text-primary">[${team1Tag}] ${team1Name}</span>
                    <span class="mx-3 text-warning fs-1">${team1Score} - ${team2Score}</span>
                    <span class="text-success">[${team2Tag}] ${team2Name}</span>
                </h2>
            </div>
        </div>

        <h4 class="text-center mb-4 text-light">📊 Maps Breakdown</h4>
        <div class="row">
    `;

    // Generate realistic map results with PROPER CS scores (13+ rounds to win)
    let team1Wins = 0;
    let team2Wins = 0;
    let team1TotalRounds = 0;
    let team2TotalRounds = 0;

    for (let i = 1; i <= totalMaps; i++) {
        const randomMapIndex = (i * 7 + matchId * 3) % maps.length;
        const mapName = maps[randomMapIndex];

        // Determine who should win this map and generate REALISTIC CS scores
        let t1_rounds, t2_rounds;

        if (team1Wins < team1Score && (team2Wins >= team2Score || Math.random() > 0.4)) {
            // Team1 wins this map - winner gets 13-16 rounds, loser gets 3-12
            t1_rounds = Math.floor(Math.random() * 4) + 13; // 13-16 rounds (winner)
            t2_rounds = Math.floor(Math.random() * 10) + 3;  // 3-12 rounds (loser)
            team1Wins++;
        } else {
            // Team2 wins this map
            t2_rounds = Math.floor(Math.random() * 4) + 13; // 13-16 rounds (winner)
            t1_rounds = Math.floor(Math.random() * 10) + 3;  // 3-12 rounds (loser)
            team2Wins++;
        }

        team1TotalRounds += t1_rounds;
        team2TotalRounds += t2_rounds;

        const mapWinner = t1_rounds > t2_rounds ? team1Name : team2Name;
        const mapWinnerTag = t1_rounds > t2_rounds ? team1Tag : team2Tag;
        const winnerClass = t1_rounds > t2_rounds ? 'text-primary' : 'text-success';
        const mapBg = t1_rounds > t2_rounds ? 'rgba(0, 212, 255, 0.1)' : 'rgba(0, 255, 136, 0.1)';

        resultsHTML += `
            <div class="col-md-4 mb-3">
                <div class="card h-100" style="background: ${mapBg}; border: 1px solid rgba(255, 255, 255, 0.2);">
                    <div class="card-header text-center">
                        <h6 class="mb-0">🗺️ Map ${i}: ${mapName}</h6>
                    </div>
                    <div class="card-body text-center">
                        <h3 class="mb-2">${t1_rounds} - ${t2_rounds}</h3>
                        <p class="${winnerClass} mb-0">
                            <i class="bi bi-trophy-fill"></i> Winner: [${mapWinnerTag}] ${mapWinner}
                        </p>
                        <small class="text-muted">${Math.floor(Math.random() * 20) + 35} minutes</small>
                    </div>
                </div>
            </div>
        `;
    }

    resultsHTML += `
        </div>

        <!-- Match Statistics -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card" style="background: rgba(255, 255, 255, 0.05);">
                    <div class="card-header text-center">
                        <h5>📈 Match Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-6">
                                <div class="stat-item mb-3">
                                    <h6 class="text-primary">[${team1Tag}] ${team1Name}</h6>
                                    <p class="mb-1 text-light">Total Rounds Won: <span class="text-warning">${team1TotalRounds}</span></p>
                                    <p class="mb-1 text-light">Maps Won: <span class="text-success">${team1Score}</span></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="stat-item mb-3">
                                    <h6 class="text-success">[${team2Tag}] ${team2Name}</h6>
                                    <p class="mb-1 text-light">Total Rounds Won: <span class="text-warning">${team2TotalRounds}</span></p>
                                    <p class="mb-1 text-light">Maps Won: <span class="text-success">${team2Score}</span></p>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <span class="badge bg-info fs-6">Match Duration: ${Math.floor(Math.random() * 60) + 90} minutes</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    resultsContent.innerHTML = resultsHTML;

    // Scroll to results with smooth animation
    resultsDiv.scrollIntoView({ behavior: 'smooth' });
}

function confirmDeleteMatch() {
    if (confirm('Are you sure you want to delete this match? This action cannot be undone.')) {
        // Add actual delete functionality here
        alert('Delete functionality would be implemented here!');
    }
}
</script>

<style>
.text-gradient {
    background: linear-gradient(45deg, #00d4ff, #ff6b35);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.prediction-team {
    transition: all 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.prediction-team:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
}
</style>

{% endblock %}